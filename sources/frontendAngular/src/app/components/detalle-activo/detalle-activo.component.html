<div class="detalle-container" *ngIf="usuario && (activo$ | async) as activo">
  <nav class="toolbar primary">
    <button class="icon-button" aria-label="Volver al mercado" routerLink="/mercado">
      <span class="icon">‚Üê</span>
    </button>
    <span class="title">Detalle de Activo</span>
    <span class="spacer"></span>
    <span class="user-info">{{ usuario.nombre }} | {{ formatearDinero(portafolioActual?.saldo || 0) }}</span>
    <button class="icon-button" aria-label="Cerrar sesi√≥n">
      <span class="icon">‚§¥</span>
    </button>
  </nav>

  <div class="content-container">
    <div class="detalle-header">
      <h1>{{ activo?.nombre ?? 'N/A' }} ({{ activo?.simbolo ?? 'N/A' }})</h1>
      <div class="precio-container">
        <span class="precio-actual">{{ formatearDinero(activo?.precio ?? 0) }}</span>
      </div>
    </div>

    <div class="detalle-content">
      <div class="detalle-cards">
        <div class="mat-card info-card">
          <div class="card-header">
            <h2 class="card-title">Informaci√≥n del Activo</h2>
          </div>
          <div class="mat-card-content">
            <div class="info-item">
              <span class="info-label">S√≠mbolo:</span>
              <span class="info-value">{{ activo?.simbolo ?? 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ activo?.nombre ?? 'N/A' }} ({{ activo?.simbolo ?? 'N/A' }})</span>
            </div>
            <div class="info-item">
              <span class="info-label">Precio actual:</span>
              <span class="info-value">{{ formatearDinero(activo?.precio ?? 0) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Variaci√≥n:</span>
              <span class="info-value" [class]="obtenerClaseVariacion(activo?.variacion ?? 0)">
                {{ (activo?.variacion ?? 0) > 0 ? '+' : '' }}{{ activo?.variacion ?? 0 }}%
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Tendencia:</span>
              <span class="info-value">
                <span class="material-icons tendencia-icon" [class]="obtenerClaseVariacion(activo?.variacion ?? 0)">
                  {{ obtenerIconoTendencia(activo?.tendencia ?? 'estable') }}
                </span>
                {{ activo?.tendencia === 'alza' ? 'Alcista' : activo?.tendencia === 'baja' ? 'Bajista' : 'Estable' }}
              </span>
            </div>
          </div>
        </div>

        <div class="acciones-card card shadow-xl rounded-xl overflow-hidden border-0 transition-all duration-300 hover:shadow-2xl">
          <div class="card-header bg-gradient-to-r from-blue-600 to-blue-700 p-5 text-white">
            <h2 class="card-title text-2xl font-bold flex items-center gap-2">
              <i class="bi bi-currency-exchange"></i>
              Realizar Transacci√≥n
            </h2>
          </div>
          <div class="card-content p-6 bg-white">
            <div class="balance-info mb-6 p-4 bg-blue-50 rounded-xl flex items-center gap-3 border border-blue-100">
              <i class="bi bi-wallet2 text-blue-600 text-xl"></i>
              <div>
                <p class="text-sm text-blue-500 font-medium">Balance del portafolio</p>
                <p class="text-2xl font-bold text-blue-700">{{ formatearDinero(portafolioActual?.saldo || 0) }}</p>
              </div>
            </div>
            <div class="modo-compra-toggle flex rounded-xl overflow-hidden mb-8 border border-gray-200 shadow-sm">
              <button 
                [class.active]="modoCantidad" 
                (click)="cambiarModoCompra(true)" 
                class="toggle-button flex-1 py-3 px-4 transition-all duration-300 font-medium"
                [class.bg-blue-600]="modoCantidad"
                [class.text-black]="true"
                [class.bg-gray-50]="!modoCantidad">
                Por Cantidad
              </button>
              <button 
                [class.active]="!modoCantidad" 
                (click)="cambiarModoCompra(false)" 
                class="toggle-button flex-1 py-2 px-4 transition-colors duration-200"
                [class.bg-blue-500]="!modoCantidad"
                [class.text-black]="true"
                [class.bg-white]="modoCantidad">
                Por Monto
              </button>
            </div>
            <form #formCompra="ngForm" (ngSubmit)="realizarTransaccion(activo?.id ?? 0, 'compra', cantidadCompra)" class="form-compra space-y-4">
              <div class="form-group mb-6" *ngIf="modoCantidad">
                <label for="cantidadCompra" class="block text-sm font-medium text-gray-600 mb-2">Cantidad de activos</label>
                <div class="relative">
                  <input 
                    type="number" 
                    id="cantidadCompra" 
                    name="cantidadCompra"
                    [(ngModel)]="cantidadCompra" 
                    (ngModelChange)="calcularMontoTotal()"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" 
                    min="0.00000001" 
                    step="0.00000001"
                    required
                    [max]="maxCantidadPosible"
                    placeholder="0.00">
                  <span class="absolute right-3 top-3 text-gray-400">{{activo?.simbolo ?? ''}}</span>
                </div>
                <p class="mt-1 text-sm text-gray-500" *ngIf="cantidadCompra && activo?.precio">
                  Monto total: {{ formatearDinero(cantidadCompra * (activo?.precio ?? 0)) }}
                </p>
              </div>
              <div class="form-group" *ngIf="!modoCantidad">
                <label for="montoCompra">Monto a invertir:</label>
                <input type="number" 
                       id="montoCompra" 
                       name="montoCompra" 
                       [(ngModel)]="montoCompra" 
                       (ngModelChange)="calcularCantidad()"
                       min="0.01" 
                       step="0.01"
                       required 
                       class="input-cantidad" 
                       [max]="portafolioActual?.saldo || 0">
                <p class="calculo-info" *ngIf="montoCompra && activo?.precio">
                  Cantidad de activos: {{ cantidadCompra | number:'1.8-8' }}
                </p>
              </div>
              <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-black font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-300 flex items-center justify-center gap-2"
                [disabled]="!formCompra.form.valid || !cantidadCompra || cantidadCompra <= 0 || !portafolioActual || (modoCantidad ? (cantidadCompra * (activo?.precio || 0)) > (portafolioActual?.saldo || 0) : montoCompra > (portafolioActual?.saldo || 0))"
                [class.opacity-50]="!formCompra.form.valid || !cantidadCompra || cantidadCompra <= 0 || !portafolioActual || (modoCantidad ? (cantidadCompra * (activo?.precio || 0)) > (portafolioActual?.saldo || 0) : montoCompra > (portafolioActual?.saldo || 0))">
                <i class="bi bi-check-circle" *ngIf="!procesando"></i>
                <i class="bi bi-arrow-repeat animate-spin" *ngIf="procesando"></i>
                {{ procesando ? 'Procesando transacci√≥n...' : 'Confirmar Compra' }}
              </button>
            </form>
            <button class="button warn" (click)="abrirDialogoTransaccion(activo, 'venta')" class="accion-button">
              <span class="icon">üóëÔ∏è</span> Vender
            </button>
          </div>
        </div>
      </div>

      <div class="grafico-card card">
        <div class="card-header">
          <h2 class="card-title">Evoluci√≥n del Precio</h2>
        </div>
        <div class="card-content">
          <div class="grafico-container" style="height: 300px; width: 100%;">
            <canvas #preciosChart width="400" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="loading-container" *ngIf="cargando">
  <div class="spinner"></div>
  <p>Cargando informaci√≥n del activo...</p>
</div>

<div class="error-container" *ngIf="error && !cargando">
  <span class="icon error-icon">‚ö†Ô∏è</span>
  <h2>No se pudo cargar el activo</h2>
  <p>Lo sentimos, no pudimos encontrar la informaci√≥n solicitada.</p>
  <button class="button primary" routerLink="/mercado">
    Volver al Mercado
  </button>
</div>

<div class="login-required" *ngIf="!usuario && !cargando && !error">
  <div class="card">
    <div class="card-content">
      <p>Debes iniciar sesi√≥n para ver detalles de activos.</p>
      <div class="login-buttons">
        <button class="button primary" routerLink="/login">Iniciar Sesi√≥n</button>
        <button class="button" routerLink="/registro">Registrarse</button>
      </div>
    </div>
  </div>
</div>