<div class="detalle-container" *ngIf="usuario && (activo$ | async) as activo">
  <nav class="toolbar primary">
    <button class="icon-button" aria-label="Volver al mercado" routerLink="/mercado">
      <span class="icon">‚Üê</span>
    </button>
    <span class="title">Detalle de Activo</span>
    <span class="spacer"></span>
    <span class="user-info">{{ usuario.nombre }} | {{ formatearDinero(usuario.balance || 0) }}</span>
    <button class="icon-button" aria-label="Cerrar sesi√≥n">
      <span class="icon">‚§¥</span>
    </button>
  </nav>

  <div class="content-container">
    <div class="detalle-header">
      <h1>{{ activo?.nombre ?? 'N/A' }} ({{ activo?.simbolo ?? 'N/A' }})</h1>
      <div class="precio-container">
        <span class="precio-actual">{{ formatearDinero(activo?.precio ?? 0) }}</span>
        <span class="variacion" [class]="obtenerClaseVariacion(activo?.variacion ?? 0)"></span>
        <span class="material-icons tendencia-icon">{{ obtenerIconoTendencia(activo?.tendencia ?? 'estable') }}
          {{ (activo?.variacion ?? 0) > 0 ? '+' : '' }}{{ activo?.variacion ?? 0 }}%
        </span>
      </div>
    </div>

    <div class="detalle-content">
      <div class="detalle-cards">
        <div class="mat-card info-card">
          <div class="card-header">
            <h2 class="card-title">Informaci√≥n del Activo</h2>
          </div>
          <div class="mat-card-content">
            <div class="info-item">
              <span class="info-label">S√≠mbolo:</span>
              <span class="info-value">{{ activo?.simbolo ?? 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ activo?.nombre ?? 'N/A' }} ({{ activo?.simbolo ?? 'N/A' }})</span>
            </div>
            <div class="info-item">
              <span class="info-label">Precio actual:</span>
              <span class="info-value">{{ formatearDinero(activo?.precio ?? 0) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Variaci√≥n:</span>
              <span class="info-value" [class]="obtenerClaseVariacion(activo?.variacion ?? 0)">
                {{ (activo?.variacion ?? 0) > 0 ? '+' : '' }}{{ activo?.variacion ?? 0 }}%
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Tendencia:</span>
              <span class="info-value">
                <span class="material-icons tendencia-icon" [class]="obtenerClaseVariacion(activo?.variacion ?? 0)">
                  {{ obtenerIconoTendencia(activo?.tendencia ?? 'estable') }}
                </span>
                {{ activo?.tendencia === 'alza' ? 'Alcista' : activo?.tendencia === 'baja' ? 'Bajista' : 'Estable' }}
              </span>
            </div>
          </div>
        </div>

        <div class="acciones-card card">
          <div class="card-header">
            <h2 class="card-title">Realizar Transacci√≥n</h2>
          </div>
          <div class="card-content">
            <p class="balance-info">Balance disponible: {{ formatearDinero(usuario.balance || 0) }}</p>
            <div class="modo-compra-toggle">
              <button [class.active]="modoCantidad" (click)="cambiarModoCompra(true)" class="toggle-button">Por Cantidad</button>
              <button [class.active]="!modoCantidad" (click)="cambiarModoCompra(false)" class="toggle-button">Por Monto</button>
            </div>
            <form #formCompra="ngForm" (ngSubmit)="realizarTransaccion(activo?.id ?? 0, 'compra', cantidadCompra)" class="form-compra">
              <div class="form-group" *ngIf="modoCantidad">
                <label for="cantidadCompra">Cantidad de activos:</label>
                <input type="number" 
                       id="cantidadCompra" 
                       name="cantidadCompra" 
                       [(ngModel)]="cantidadCompra" 
                       (ngModelChange)="calcularMontoTotal()"
                       min="0.00000001" 
                       step="0.00000001"
                       required 
                       class="input-cantidad" 
                       [max]="maxCantidadPosible">
                <p class="calculo-info" *ngIf="cantidadCompra && activo?.precio">
                  Monto total: {{ formatearDinero(cantidadCompra * (activo?.precio ?? 0)) }}
                </p>
              </div>
              <div class="form-group" *ngIf="!modoCantidad">
                <label for="montoCompra">Monto a invertir:</label>
                <input type="number" 
                       id="montoCompra" 
                       name="montoCompra" 
                       [(ngModel)]="montoCompra" 
                       (ngModelChange)="calcularCantidad()"
                       min="0.01" 
                       step="0.01"
                       required 
                       class="input-cantidad" 
                       [max]="usuario.balance">
                <p class="calculo-info" *ngIf="montoCompra && activo?.precio">
                  Cantidad de activos: {{ cantidadCompra | number:'1.8-8' }}
                </p>
              </div>
              <button class="button primary" 
                      type="submit" 
                      [disabled]="!formCompra.form.valid || !cantidadCompra || cantidadCompra <= 0 || (modoCantidad ? (cantidadCompra * (activo?.precio || 0)) > (usuario.balance || 0) : montoCompra > (usuario.balance || 0))">
                <span class="icon">üõí</span> Confirmar Compra
              </button>
            </form>
            <button class="button warn" (click)="abrirDialogoTransaccion(activo, 'venta')" class="accion-button">
              <span class="icon">üóëÔ∏è</span> Vender
            </button>
          </div>
        </div>
      </div>

      <div class="grafico-card card">
        <div class="card-header">
          <h2 class="card-title">Evoluci√≥n del Precio</h2>
        </div>
        <div class="card-content">
          <div class="grafico-container" style="height: 300px; width: 100%;">
            <canvas #preciosChart width="400" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="loading-container" *ngIf="cargando">
  <div class="spinner"></div>
  <p>Cargando informaci√≥n del activo...</p>
</div>

<div class="error-container" *ngIf="error && !cargando">
  <span class="icon error-icon">‚ö†Ô∏è</span>
  <h2>No se pudo cargar el activo</h2>
  <p>Lo sentimos, no pudimos encontrar la informaci√≥n solicitada.</p>
  <button class="button primary" routerLink="/mercado">
    Volver al Mercado
  </button>
</div>

<div class="login-required" *ngIf="!usuario && !cargando && !error">
  <div class="card">
    <div class="card-content">
      <p>Debes iniciar sesi√≥n para ver detalles de activos.</p>
      <div class="login-buttons">
        <button class="button primary" routerLink="/login">Iniciar Sesi√≥n</button>
        <button class="button" routerLink="/registro">Registrarse</button>
      </div>
    </div>
  </div>
</div>